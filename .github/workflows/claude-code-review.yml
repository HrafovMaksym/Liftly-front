name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

# Cancel previous runs for same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review:
    runs-on: ubuntu-latest
    if: |
      !contains(github.event.pull_request.title, '[skip-review]') &&
      !contains(github.event.pull_request.labels.*.name, 'skip-review')
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code Review
        id: review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          use_sticky_comment: true
          include_fix_links: true
          show_full_output: true

          prompt: |
            Review the PR diff thoroughly. Follow ALL rules from CLAUDE.md.

            Focus ONLY on the changed files in this PR diff. Do NOT try to list PRs or run git commands.
            Use Read, Glob, and Grep tools to inspect source files if needed.

            ## Review Checklist

            ### Security
            - Check for exposed secrets, API keys, tokens, passwords in code
            - Verify all user input is validated
            - Check for XSS vectors

            ### TypeScript
            - Flag any use of `any` type
            - Check for missing return types on functions

            ### Quality
            - No console.log left in code
            - No commented-out code
            - No TODO without linked issue number
            - No hardcoded magic numbers, URLs, or credentials

            ## Output Format
            For each issue found, provide:
            1. Severity: CRITICAL | WARNING | SUGGESTION
            2. File and line
            3. What's wrong
            4. How to fix

            End with a summary line, exactly one of:
            REVIEW_VERDICT: APPROVE
            REVIEW_VERDICT: BLOCK

            Output BLOCK if there are any CRITICAL issues. Output APPROVE otherwise.

          claude_args: |
            --max-turns 10
            --model claude-sonnet-4-5-20250929
            --allowedTools Read Glob Grep

      - name: Post review comment
        if: always() && steps.review.outcome == 'success'
        run: |
          EXEC_FILE="/home/runner/work/_temp/claude-execution-output.json"
          if [ ! -f "$EXEC_FILE" ]; then
            echo "::warning::No execution output file found"
            exit 0
          fi

          # File is NDJSON (one JSON object per line) â€” must use -s to slurp into array
          # || true prevents bash -e from killing the script on jq failure

          # Try: last entry that has a .result field
          jq -s -r 'map(select(.result)) | last | .result // empty' "$EXEC_FILE" > /tmp/review-body.md 2>/dev/null || true

          # Fallback: text content from the last assistant message
          if [ ! -s /tmp/review-body.md ]; then
            jq -s -r '[.[] | select(.type == "assistant")] | last | [.message.content[] | select(.type == "text") | .text] | join("\n")' "$EXEC_FILE" > /tmp/review-body.md 2>/dev/null || true
          fi

          if [ -s /tmp/review-body.md ]; then
            gh pr comment ${{ github.event.pull_request.number }} --body-file /tmp/review-body.md
          else
            echo "::warning::Could not extract review text from execution output"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Check review verdict
        if: always() && steps.review.outcome == 'success'
        run: |
          if grep -q "REVIEW_VERDICT: BLOCK" /home/runner/work/_temp/claude-execution-output.json; then
            echo "ðŸ”´ Claude found critical issues â€” blocking merge"
            exit 1
          fi
          echo "âœ… No critical issues found"
